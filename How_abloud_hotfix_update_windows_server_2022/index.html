<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="随便聊聊:如何硬气的打补丁不重启" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="随便聊聊:为什么打补丁要重启" /><meta property="og:description" content="随便聊聊:为什么打补丁要重启" /><link rel="canonical" href="https://kukisama.github.io/How_abloud_hotfix_update_windows_server_2022/" /><meta property="og:url" content="https://kukisama.github.io/How_abloud_hotfix_update_windows_server_2022/" /><meta property="og:site_name" content="不太皮的九叔" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-02-23T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="随便聊聊:如何硬气的打补丁不重启" /><meta name="twitter:site" content="@jiuzige" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-08-18T15:21:21+08:00","datePublished":"2022-02-23T00:00:00+08:00","description":"随便聊聊:为什么打补丁要重启","headline":"随便聊聊:如何硬气的打补丁不重启","mainEntityOfPage":{"@type":"WebPage","@id":"https://kukisama.github.io/How_abloud_hotfix_update_windows_server_2022/"},"url":"https://kukisama.github.io/How_abloud_hotfix_update_windows_server_2022/"}</script><title>随便聊聊:如何硬气的打补丁不重启 | 不太皮的九叔</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="不太皮的九叔"><meta name="application-name" content="不太皮的九叔"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">不太皮的九叔</a></div><div class="site-subtitle font-italic">一个不爱吹牛逼的打工仔</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/kukisama" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/jiuzige" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['a9y#foxmail.com',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>随便聊聊:如何硬气的打补丁不重启</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>随便聊聊:如何硬气的打补丁不重启</h1><div class="post-meta text-muted"> <span> 发表于 <em class="" data-ts="1645545600" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-02-23 </em> </span> <span> 更新于 <em class="" data-ts="1660807281" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-08-18 </em> </span><div class="d-flex justify-content-between"> <span> 作者 <em> <a href="https://twitter.com/jiuzige">不太皮的九叔</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4348 字"> <em>24 分钟</em>阅读</span></div></div></div><div class="post-content"><h1 id="随便聊聊为什么打补丁要重启">随便聊聊:为什么打补丁要重启</h1><h2 id="引子"><span class="mr-2">引子</span><a href="#引子" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>我有一个朋友，因为最近微软出了很多漏洞修复补丁，导致需要频繁的打补丁。在打补丁重启之后，有些机器出现了蓝屏等等一些奇怪的问题。所以问题来了，为什么给Windows打补丁要重启，不重启行不行。</p><h2 id="结论"><span class="mr-2">结论</span><a href="#结论" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>先说结论，不重启大部分情况下是没问题的。但是<code class="language-plaintext highlighter-rouge">不建议</code></p><h2 id="需要重启的理由"><span class="mr-2">需要重启的理由</span><a href="#需要重启的理由" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="动态链接库"><span class="mr-2">动态链接库</span><a href="#动态链接库" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>在分析原因之前，需要先聊一下，为什么需要重启。在聊重启之前，又要聊一下Windows的<code class="language-plaintext highlighter-rouge">动态链接库 (DLL) </code>。</p><p>动态链接库相当于组成乐高的不同砖块。有些是铺在底下的砖头，如果要更换这些砖头，就需要把这块砖上关联的东西都铲了（停止），才能更换。比如要拆除下图左下角的砖，换一个别的颜色。除了把整个风车拆除，别无她法。</p><p><img data-src="../assets/image-20220211130657308.png" alt="image-20220211130657308" data-proofer-ignore></p><blockquote><p>对于Windows，操作系统的很多功能都由 DLL 提供。 此外，当您在这些操作系统中的一个Windows程序时，该程序的很多功能可能由 DLL 提供。 例如，某些程序可能包含许多不同的模块，并且程序的每个模块包含在 DLL 中并分发。</p><p>使用 DLL 有助于促进代码的模块化、代码重用、高效的内存使用并减少磁盘空间。 因此，操作系统和程序加载速度更快，运行速度更快，并且占用了更少的磁盘空间。</p></blockquote><h3 id="为什么会重启"><span class="mr-2">为什么会重启</span><a href="#为什么会重启" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>知道了最重要的原理，回到为什么会重启的问题：安装安全更新后，如果满足下列条件之一，系统可能会提示您重新启动计算机：</p><ul><li>安全更新将更新一个 DLL，该 DLL 加载在由 Windows 所需的一个或多个进程中<li>安全更新将更新.exe文件，该文件当前作为应用程序所需的进程Windows<li>安全更新将更新当前使用的设备驱动程序，以及当前Windows。 使用此设备驱动程序时无法完成更新，但是，你无法卸载此设备驱动程序，除非你关闭Windows。<li>安全更新对注册表进行更改。 这些更改要求您重新启动计算机。<li>安全更新将更改在您启动计算机时只读的注册表项。</ul><p>说了那么多点，在于更新的过程，可能（很大概率）会修改Windows的基石。如果细心观察，有的小伙伴可能会遇到系统提示<code class="language-plaintext highlighter-rouge">当前无法安装补丁，会在下一次重启时安装</code>。</p><h2 id="重启的几种状态"><span class="mr-2">重启的几种状态</span><a href="#重启的几种状态" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>在我们双击补丁程序之后，可能会发生以下几种情况</p><ul><li>没有任何提示，系统不要求重启<li>要求重启<li>提示在下一次重启时进行安装。</ul><h2 id="打补丁为什么会打出新问题"><span class="mr-2">打补丁为什么会打出新问题</span><a href="#打补丁为什么会打出新问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>微软的补丁有一个特色，就是可能会解决一些问题的同时，带来一些新问题。</p><p>事情的根因大约可以归于动态链接库机制。不同的应用、服务、角色之间有着千丝万缕的关联。Windows上可以安装各种各样的软件、功能、角色，在补丁发版之前很难说做到万全的测试。如果很不幸的撞到了没有测试的项目上，就算中招了。</p><p>再比如，安装完某个补丁后没有重启，然后开始安装新的补丁。这种场景测试人员也很难复现。</p><p>更为严重的是，如果打补丁出现问题，也不见得次次都能还原回去。</p><h2 id="重启能解决什么问题"><span class="mr-2">重启能解决什么问题</span><a href="#重启能解决什么问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>回到最初的问题，虽然问题是打补丁为什么要重启（打完补丁之后重启），但在打补丁之前，我们提前重启一次，可以避免很多问题。</p><ul><li>当前系统安装完补丁还未重启<li>当前系统安装完某个软件后未重启<li>当前系统的某个功能或角色，配置完成后还未重启</ul><p>如果在安装补丁之前，提前重启一次，以上问题带来的潜在风险都可以避免。</p><h2 id="检查是否需要重启"><span class="mr-2">检查是否需要重启</span><a href="#检查是否需要重启" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>在打补丁之前重启，是为了避免存在一些已经要重启了但是没重启的情况，但是这种状态可以提前查询么？答案是肯定的。当重新启动挂起时，Windows 会添加一些注册表值来显示这一点。所以要做的就是检查这些各种各样的注册表。</p><p>下面的这个脚本来自<code class="language-plaintext highlighter-rouge">Adam Bertram</code>，作者是<a href="https://mvp.microsoft.com/en-us/PublicProfile/5001322">微软的在任MVP</a>。直接照抄就可以了。</p><p><img data-src="../assets/image-20220211133130145.png" alt="image-20220211133130145" data-proofer-ignore></p><p>展示效果具体是这样的</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">PS51</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Test-PendingReboot.ps1</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">localhost</span><span class="w">

</span><span class="n">ComputerName</span><span class="w"> </span><span class="nx">IsPendingReboot</span><span class="w">
</span><span class="o">------------</span><span class="w"> </span><span class="o">---------------</span><span class="w">
</span><span class="n">localhost</span><span class="w">              </span><span class="nx">False</span><span class="w">
</span></pre></table></code></div></div><p>以下是测试代码。</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
</pre><td class="rouge-code"><pre><span class="kr">function</span><span class="w"> </span><span class="nf">TestPendingreboot</span><span class="p">(</span><span class="nv">$ComputerName</span><span class="p">)</span><span class="w">
</span><span class="p">{</span><span class="w">
	</span><span class="c">#功能来源：https://adamtheautomator.com/pending-reboot-registry-windows/</span><span class="w">
	</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$ComputerName</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">";"</span><span class="p">)</span><span class="w">
	</span><span class="p">{</span><span class="w"> </span><span class="nv">$ComputerName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$ComputerName</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">";"</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w">

	</span><span class="nv">$scriptBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="kr">function</span><span class="w"> </span><span class="nf">Test-RegistryKey</span><span class="w">
		</span><span class="p">{</span><span class="w">
			</span><span class="p">[</span><span class="n">OutputType</span><span class="p">(</span><span class="s1">'bool'</span><span class="p">)]</span><span class="w">
			</span><span class="p">[</span><span class="n">CmdletBinding</span><span class="p">()]</span><span class="w">
			</span><span class="kr">param</span><span class="w">
			</span><span class="p">(</span><span class="w">
				</span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
				</span><span class="p">[</span><span class="n">ValidateNotNullOrEmpty</span><span class="p">()]</span><span class="w">
				</span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nv">$Key</span><span class="w">
			</span><span class="p">)</span><span class="w">
			
			</span><span class="bp">$Error</span><span class="n">ActionPreference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Stop'</span><span class="w">
			
			</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">Get-Item</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$Key</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">Ignore</span><span class="p">)</span><span class="w">
			</span><span class="p">{</span><span class="w">
				</span><span class="bp">$true</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w">
		
		</span><span class="kr">function</span><span class="w"> </span><span class="nf">Test-RegistryValue</span><span class="w">
		</span><span class="p">{</span><span class="w">
			</span><span class="p">[</span><span class="n">OutputType</span><span class="p">(</span><span class="s1">'bool'</span><span class="p">)]</span><span class="w">
			</span><span class="p">[</span><span class="n">CmdletBinding</span><span class="p">()]</span><span class="w">
			</span><span class="kr">param</span><span class="w">
			</span><span class="p">(</span><span class="w">
				</span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
				</span><span class="p">[</span><span class="n">ValidateNotNullOrEmpty</span><span class="p">()]</span><span class="w">
				</span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nv">$Key</span><span class="p">,</span><span class="w">
				</span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
				</span><span class="p">[</span><span class="n">ValidateNotNullOrEmpty</span><span class="p">()]</span><span class="w">
				</span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nv">$Value</span><span class="w">
			</span><span class="p">)</span><span class="w">
			
			</span><span class="bp">$Error</span><span class="n">ActionPreference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Stop'</span><span class="w">
			
			</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">Get-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$Key</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$Value</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">Ignore</span><span class="p">)</span><span class="w">
			</span><span class="p">{</span><span class="w">
				</span><span class="bp">$true</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w">
		
		</span><span class="kr">function</span><span class="w"> </span><span class="nf">Test-RegistryValueNotNull</span><span class="w">
		</span><span class="p">{</span><span class="w">
			</span><span class="p">[</span><span class="n">OutputType</span><span class="p">(</span><span class="s1">'bool'</span><span class="p">)]</span><span class="w">
			</span><span class="p">[</span><span class="n">CmdletBinding</span><span class="p">()]</span><span class="w">
			</span><span class="kr">param</span><span class="w">
			</span><span class="p">(</span><span class="w">
				</span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
				</span><span class="p">[</span><span class="n">ValidateNotNullOrEmpty</span><span class="p">()]</span><span class="w">
				</span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nv">$Key</span><span class="p">,</span><span class="w">
				</span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
				</span><span class="p">[</span><span class="n">ValidateNotNullOrEmpty</span><span class="p">()]</span><span class="w">
				</span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nv">$Value</span><span class="w">
			</span><span class="p">)</span><span class="w">
			
			</span><span class="bp">$Error</span><span class="n">ActionPreference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Stop'</span><span class="w">
			
			</span><span class="kr">if</span><span class="w"> </span><span class="p">((</span><span class="nv">$regVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$Key</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$Value</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">Ignore</span><span class="p">)</span><span class="w"> </span><span class="o">-and</span><span class="w"> </span><span class="nv">$regVal</span><span class="o">.</span><span class="p">(</span><span class="nv">$Value</span><span class="p">))</span><span class="w">
			</span><span class="p">{</span><span class="w">
				</span><span class="bp">$true</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w">
		
		</span><span class="c"># Added "test-path" to each test that did not leverage a custom function from above since</span><span class="w">
		</span><span class="c"># an exception is thrown when Get-ItemProperty or Get-ChildItem are passed a nonexistant key path</span><span class="w">
		</span><span class="nv">$tests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="w">
			</span><span class="p">{</span><span class="w"> </span><span class="n">Test-RegistryKey</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s1">'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Component Based Servicing\RebootPending'</span><span class="w"> </span><span class="p">}</span><span class="w">
			</span><span class="p">{</span><span class="w"> </span><span class="n">Test-RegistryKey</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s1">'HKLM:\Software\Microsoft\Windows\CurrentVersion\Component Based Servicing\RebootInProgress'</span><span class="w"> </span><span class="p">}</span><span class="w">
			</span><span class="p">{</span><span class="w"> </span><span class="n">Test-RegistryKey</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s1">'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate\Auto Update\RebootRequired'</span><span class="w"> </span><span class="p">}</span><span class="w">
			</span><span class="p">{</span><span class="w"> </span><span class="n">Test-RegistryKey</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s1">'HKLM:\Software\Microsoft\Windows\CurrentVersion\Component Based Servicing\PackagesPending'</span><span class="w"> </span><span class="p">}</span><span class="w">
			</span><span class="p">{</span><span class="w"> </span><span class="n">Test-RegistryKey</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s1">'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate\Auto Update\PostRebootReporting'</span><span class="w"> </span><span class="p">}</span><span class="w">
			</span><span class="p">{</span><span class="w"> </span><span class="n">Test-RegistryValueNotNull</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s1">'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s1">'PendingFileRenameOperations'</span><span class="w"> </span><span class="p">}</span><span class="w">
			</span><span class="p">{</span><span class="w"> </span><span class="n">Test-RegistryValueNotNull</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s1">'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s1">'PendingFileRenameOperations2'</span><span class="w"> </span><span class="p">}</span><span class="w">
			</span><span class="p">{</span><span class="w">
				</span><span class="c"># Added test to check first if key exists, using "ErrorAction ignore" will incorrectly return $true</span><span class="w">
				</span><span class="s1">'HKLM:\SOFTWARE\Microsoft\Updates'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="w"> </span><span class="n">test-path</span><span class="w"> </span><span class="bp">$_</span><span class="w"> </span><span class="nt">-PathType</span><span class="w"> </span><span class="nx">Container</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">%</span><span class="p">{</span><span class="w">
					</span><span class="p">(</span><span class="n">Get-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="bp">$_</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'UpdateExeVolatile'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">UpdateExeVolatile</span><span class="p">)</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="mi">0</span><span class="w">
				</span><span class="p">}</span><span class="w">
			</span><span class="p">}</span><span class="w">
			</span><span class="p">{</span><span class="w"> </span><span class="n">Test-RegistryValue</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s1">'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s1">'DVDRebootSignal'</span><span class="w"> </span><span class="p">}</span><span class="w">
			</span><span class="p">{</span><span class="w"> </span><span class="n">Test-RegistryKey</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s1">'HKLM:\SOFTWARE\Microsoft\ServerManager\CurrentRebootAttemps'</span><span class="w"> </span><span class="p">}</span><span class="w">
			</span><span class="p">{</span><span class="w"> </span><span class="n">Test-RegistryValue</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s1">'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s1">'JoinDomain'</span><span class="w"> </span><span class="p">}</span><span class="w">
			</span><span class="p">{</span><span class="w"> </span><span class="n">Test-RegistryValue</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s1">'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s1">'AvoidSpnSet'</span><span class="w"> </span><span class="p">}</span><span class="w">
			</span><span class="p">{</span><span class="w">
				</span><span class="c"># Added test to check first if keys exists, if not each group will return $Null</span><span class="w">
				</span><span class="c"># May need to evaluate what it means if one or both of these keys do not exist</span><span class="w">
				</span><span class="p">(</span><span class="s1">'HKLM:\SYSTEM\CurrentControlSet\Control\ComputerName\ActiveComputerName'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="w"> </span><span class="n">test-path</span><span class="w"> </span><span class="bp">$_</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">%</span><span class="p">{</span><span class="w"> </span><span class="p">(</span><span class="n">Get-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="bp">$_</span><span class="p">)</span><span class="o">.</span><span class="nf">ComputerName</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="o">-ne</span><span class="w">
				</span><span class="p">(</span><span class="s1">'HKLM:\SYSTEM\CurrentControlSet\Control\ComputerName\ComputerName'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="w"> </span><span class="n">test-path</span><span class="w"> </span><span class="bp">$_</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">%</span><span class="p">{</span><span class="w"> </span><span class="p">(</span><span class="n">Get-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="bp">$_</span><span class="p">)</span><span class="o">.</span><span class="nf">ComputerName</span><span class="w"> </span><span class="p">})</span><span class="w">
			</span><span class="p">}</span><span class="w">
			</span><span class="p">{</span><span class="w">
				</span><span class="c"># Added test to check first if key exists</span><span class="w">
				</span><span class="s1">'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate\Services\Pending'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="p">(</span><span class="n">Test-Path</span><span class="w"> </span><span class="bp">$_</span><span class="p">)</span><span class="w"> </span><span class="o">-and</span><span class="w"> </span><span class="p">(</span><span class="n">Get-ChildItem</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="bp">$_</span><span class="p">)</span><span class="w">
				</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="p">}</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">)</span><span class="w">
		
		</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$test</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$tests</span><span class="p">)</span><span class="w">
		</span><span class="p">{</span><span class="w">
			</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="w"> </span><span class="nv">$test</span><span class="p">)</span><span class="w">
			</span><span class="p">{</span><span class="w">
				</span><span class="bp">$true</span><span class="w">
				</span><span class="kr">break</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">}</span><span class="w">
	
	</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$computer</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$ComputerName</span><span class="p">)</span><span class="w">
	</span><span class="p">{</span><span class="w">
		
		</span><span class="nv">$connParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
			</span><span class="s1">'ComputerName'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$computer</span><span class="w">
		</span><span class="p">}</span><span class="w">
		
		
		</span><span class="nv">$output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
			</span><span class="nx">ComputerName</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">$computer</span><span class="w">
			</span><span class="nx">IsPendingReboot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$false</span><span class="w">
		</span><span class="p">}</span><span class="w">
		
		</span><span class="nv">$psRemotingSession</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-PSSession</span><span class="w"> </span><span class="err">@</span><span class="nx">connParams</span><span class="w">
		
		</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">-not</span><span class="w"> </span><span class="p">(</span><span class="nv">$output</span><span class="o">.</span><span class="nf">IsPendingReboot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Invoke-Command</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$psRemotingSession</span><span class="w"> </span><span class="nt">-ScriptBlock</span><span class="w"> </span><span class="nv">$scriptBlock</span><span class="p">))</span><span class="w">
		</span><span class="p">{</span><span class="w">
			</span><span class="nv">$output</span><span class="o">.</span><span class="nf">IsPendingReboot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$false</span><span class="w">
		</span><span class="p">}</span><span class="w">
		</span><span class="p">[</span><span class="n">pscustomobject</span><span class="p">]</span><span class="nv">$output</span><span class="w">
		
		
	</span><span class="p">}</span><span class="w">
	
</span><span class="p">}</span><span class="w">

</span></pre></table></code></div></div><h2 id="总结"><span class="mr-2">总结</span><a href="#总结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>想一想，因为疫情的紧张，我们已经知道出门要戴口罩。</p><blockquote><p>先说结论，不<code class="language-plaintext highlighter-rouge">带口罩</code>大部分情况下是没问题的。但是<code class="language-plaintext highlighter-rouge">不建议</code></p></blockquote><p>同理，打补丁重启其实没什么可讨论的，当把它当做一个预防和保护措施的时候，能够节省很多麻烦。当然最重要的是，打补丁之前要做足够多的验证。</p><h1 id="随便聊聊如何硬气的打补丁不重启">随便聊聊:如何硬气的打补丁不重启</h1><p>上一篇文章介绍了为什么微软的系统，打补丁了要重启。这是一个既成事实，说的是如何去接受这个事实。</p><p>但是今天的故事会更有一点意思，我们介绍一下特定场景中，如何做到打补丁不重启的，也就是不去接受上面的事实。</p><p>虽然打补丁重启很麻烦，但是需要注意的是，在Windows 10/Windows Server 2016以后的操作系统中，我们不需要在意补丁的细节，只需要安装最新的补丁，这种补丁是累计更新的。</p><p>而在Windows7以及更早的系统中，补丁的安装是这样的：</p><p><img data-src="../assets/image-20220223140844449.png" alt="image-20220223140844449" data-proofer-ignore></p><p>早期的补丁安装方式优点和缺点同样明显：</p><ul><li>补丁一般有专门的应对功能，相对体积较小，安装速度快。<li>补丁2的安装可能依赖补丁1，有时候不见得会有很明确的说明。<li>补丁3可能替换了补丁1，在安装补丁3的时候不需要安装补丁1。<li>安装补丁依然会有可能需要重启。</ul><h2 id="如何做到打补丁不重启"><span class="mr-2">如何做到打补丁不重启</span><a href="#如何做到打补丁不重启" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>打补丁不重启不是什么高科技，这只是微软的产品功能。说到功能，就要理解一般来说，这会有限制条件。一个恰当的比喻类似于显卡的<code class="language-plaintext highlighter-rouge">光线追踪</code>。</p><p>而在打补丁这个事情里，这项技术叫做 <code class="language-plaintext highlighter-rouge">Azure Automanage 热补丁</code>，他是随着<code class="language-plaintext highlighter-rouge">Windows Server 2022</code>的发布而带来的功能，但是这项功能又不是泛指所有的<code class="language-plaintext highlighter-rouge">Windows Server 2022</code>，它只支持一种操作系统</p><ul><li>Windows Server 2022（core）</ul><p>再次强调一下，是Windows Server 2022的<code class="language-plaintext highlighter-rouge">CORE</code>版。虽然使用CORE版会减低被攻击的风险，但是没有图形界面对大多数朋友来说，应该还是会带来一些障碍的。</p><p>而且也不是随便一个平台，随便一个版本就支持，它只存在下面两种环境中。</p><ul><li>Azure（公有云）<li>AzureStack HCI（混合云）</ul><p>也就是说，本地化的Windows Server 2022（零售、EA）并不支持这项功能。要在自家数据中心使用这项功能，必须要使用AzureStack HCI，而云端则必须要选择Azure。</p><h2 id="什么是-azure-automanage--热补丁"><span class="mr-2">什么是 Azure Automanage 热补丁</span><a href="#什么是-azure-automanage--热补丁" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>这里简单介绍一下这项功能：</p><p>“Windows Server 2022 Datacenter：Azure 版本”支持 Azure Automanage 中的热补丁。 热修补是在新的 Windows Server Azure Edition 虚拟机 (VM) 上安装更新的一种新方式，安装后无需重新启动。 有关详细信息，请参阅 <a href="https://docs.microsoft.com/en-us/azure/automanage/automanage-hotpatch">Azure Automanage 文档</a>。</p><p>热补丁目前处于<code class="language-plaintext highlighter-rouge">公共预览版</code>中。需要一个选择加入程序才能使用下面描述的功能。此预览版在没有服务级别协议的情况下提供，不建议用于生产工作负载。某些功能可能不受支持或功能受限。有关详细信息，请参阅<a href="https://azure.microsoft.com/support/legal/preview-supplemental-terms/">Microsoft Azure 预览版的补充使用条款</a>。</p><h2 id="热补丁的工作原理"><span class="mr-2">热补丁的工作原理</span><a href="#热补丁的工作原理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Hotpatch 的工作原理是首先使用 Windows 更新最新累积更新建立基线。基于该基线的热补丁会定期发布（例如，每月的第二个星期二）。热补丁将包含不需要重新启动的更新。定期（从每三个月开始）使用新的最新累积更新刷新基线。</p><p><img data-src="../assets/hotpatch-sample-schedule.png" alt="Hotpatch 示例时间表。" data-proofer-ignore></p><p>上面的话很官方，简单来说就是这样：</p><ul><li>可以做到打补丁不重启，但是这只能坚挺三个月<li>每3个月会打一个基线补丁，这个时候会重启。<li>周而复始</ul><p>回到和Windows7时代的补丁机制对比，每个补丁很小，对系统的影响相对较小。但是每3个月会对齐一下基线，让补丁不至于和Win7一样乱，这对于解决补丁依赖和补丁替代，会有积极的作用。</p><p>除了上面计划内的补丁安装之外，也可能会出现一些计划外的补丁，比如重大的0day，那就可能会发布新的需要重启的补丁。</p><p>补丁安装的原则是这样的：</p><ul><li>分类为“关键”或“安全”的补丁会自动下载并应用到虚拟机上。<li>在 VM 时区的非高峰时段应用补丁程序。<li>补丁编排由 Azure 管理，补丁的应用遵循<a href="https://docs.microsoft.com/en-us/azure/virtual-machines/automatic-vm-guest-patching#availability-first-updates">可用性优先原则</a>。<li>监控通过平台健康信号确定的虚拟机健康状况以检测修补故障。</ul><h2 id="实现"><span class="mr-2">实现</span><a href="#实现" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>要开始在Azure上新 VM 上使用热补丁，请执行以下步骤：</p><ol><li>启用<code class="language-plaintext highlighter-rouge">预览访问</code><ul><li>每个订阅都需要启用一次性预览访问权限。<li>可以通过 API、PowerShell 或 CLI 启用预览访问，如下面的“启用预览访问”部分所述。</ul><li>从 Azure 门户开始创建新 VM<ul><li>在预览期间，您需要开始使用<a href="https://aka.ms/ws2022ae-portal-preview">此特定链接创建</a>。</ul><p><img data-src="../assets/image-20220214161837579.png" alt="image-20220214161837579" style="zoom: 33%;" data-proofer-ignore></p><li>在 VM 创建期间提供详细信息<ul><li>确保在“图像”下拉列表中选择了受支持的<em>Windows Server Azure 版图像。</em>使用<a href="https://docs.microsoft.com/en-us/azure/automanage/automanage-windows-server-services-overview#getting-started-with-windows-server-azure-edition">本指南</a>确定支持哪些图像。<li>在“来宾操作系统更新”部分下的“管理”选项卡上，选中“启用热补丁”复选框以在预览时评估热补丁。补丁编排选项将设置为“Azure 编排”。<li>在“Azure Automanage”部分下的“管理”选项卡上，为“Azure Automanage 环境”选择“开发/测试”或“生产”，以在预览时评估 Automanage 机器最佳实践。</ul><li>创建你的新虚拟机</ol><h2 id="补丁更新"><span class="mr-2">补丁更新</span><a href="#补丁更新" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>我们可以手动的对系统打一下补丁，试验一下效果，看看到底是不是真的不用重启。</p><ul><li>在安装好的操作系统，进入<code class="language-plaintext highlighter-rouge">来宾和主机更新</code>→<code class="language-plaintext highlighter-rouge">转到热补丁（预览）</code></ul><p><img data-src="../assets/image-20220223142652568.png" alt="image-20220223142652568" style="zoom:33%;" data-proofer-ignore></p><ul><li>在这个界面<code class="language-plaintext highlighter-rouge">Assess updates</code>→<code class="language-plaintext highlighter-rouge">立即触发评估</code>→<code class="language-plaintext highlighter-rouge">确定</code></ul><p><img data-src="../assets/image-20220223142852714.png" alt="image-20220223142852714" style="zoom:33%;" data-proofer-ignore></p><ul><li>等待评估结束，可以看到能够安装的补丁会在下方列出来。</ul><p><img data-src="../assets/image-20220223142235882.png" alt="image-20220223142235882" style="zoom: 33%;" data-proofer-ignore></p><ul><li>此时可以点击顶部的<code class="language-plaintext highlighter-rouge">Manage updates</code>→<code class="language-plaintext highlighter-rouge">one-time update</code>进行手动安装补丁</ul><p><img data-src="../assets/image-20220223143056847.png" alt="image-20220223143056847" style="zoom:33%;" data-proofer-ignore></p><ul><li>进行如下配置，默认不需要修改</ul><p><img data-src="../assets/image-20220223143143327.png" alt="image-20220223143143327" style="zoom:33%;" data-proofer-ignore></p><ul><li>在左侧点击<code class="language-plaintext highlighter-rouge">+包含更新分类</code>，勾选所有</ul><p><img data-src="../assets/image-20220223143206473.png" alt="image-20220223143206473" style="zoom: 25%;" data-proofer-ignore></p><ul><li>刚才发现的补丁就可以安装了。点击<code class="language-plaintext highlighter-rouge">下一步</code>继续</ul><p><img data-src="../assets/image-20220223143253721.png" alt="image-20220223143253721" data-proofer-ignore></p><ul><li>确认无误，正式安装</ul><p><img data-src="../assets/image-20220223143332467.png" alt="image-20220223143332467" style="zoom:33%;" data-proofer-ignore></p><ul><li>右上角会出现提示正在安装。</ul><p><img data-src="../assets/image-20220223143358413.png" alt="image-20220223143358413" style="zoom:33%;" data-proofer-ignore></p><ul><li>由于补丁不大，安装很快结束。</ul><p><img data-src="../assets/image-20220223143430204.png" alt="image-20220223143430204" style="zoom:33%;" data-proofer-ignore></p><ul><li>一条正常的安装日志，大概是长这个样子的。</ul><p><img data-src="../assets/image-20220223143456110.png" alt="image-20220223143456110" style="zoom:33%;" data-proofer-ignore></p><h2 id="补丁安装失败的情况处理"><span class="mr-2">补丁安装失败的情况处理</span><a href="#补丁安装失败的情况处理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>在我的测试过程中，我发现补丁安装有失败的情况，那这个锅应该甩给热补丁么？</p><ul><li>检查日志，看到有如下错误提示</ul><p><img data-src="../assets/image-20220223143610208.png" alt="image-20220223143610208" style="zoom:33%;" data-proofer-ignore></p><ul><li>这里也能看到相应错误提示</ul><p><img data-src="../assets/image-20220223143949753.png" alt="image-20220223143949753" style="zoom:33%;" data-proofer-ignore></p><ul><li>前往虚拟机，查看日志，由于是个core系统，没有资源管理器，所以需要开一个notepad，然后在notepad里面，使用<code class="language-plaintext highlighter-rouge">打开</code>，操作这个窗口。在这里，我们可以选择<code class="language-plaintext highlighter-rouge">单个文件</code>，通过远程桌面，可以把文件拷贝出来。日志检查没有发现异常的地方。</ul><p><img data-src="../assets/image-20220223143707690.png" alt="image-20220223143707690" style="zoom:33%;" data-proofer-ignore></p><ul><li>检查日志过程中，发现裸机内存占用很大，远程桌面也有时会断联。</ul><p><img data-src="../assets/image-20220223143804652.png" alt="image-20220223143804652" style="zoom:33%;" data-proofer-ignore></p><ul><li>内存扩容为3.5G，裸连直接使用掉2G，因此可以下定论，Windows Server 2022比较占用内存资源，即使是CORE，也要分配4G内存。</ul><p><img data-src="../assets/image-20220223143827084.png" alt="image-20220223143827084" style="zoom:33%;" data-proofer-ignore></p><ul><li>内存扩容后，补丁安装正常，现阶段可以看出来，Windows Server 2022对系统资源要求相对较高，这一块大家一定要有心理预期。</ul><h2 id="总结-1"><span class="mr-2">总结</span><a href="#总结-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>从我最早知道热补丁这个概念的时候，我对他的期待还是蛮高的，安装补丁要重启，重启就有可能带来各种意外的问题。所以不重启的话，就能减低出现问题的可能性。</p><p>现在的功能从标配的次次重启改成了3个月重启一次。并且在Azure上，可以由Azure来托管补丁的安装过程。这对于云端用户是个利好消息。</p><p>而本地化的用户呢？其实这种改变对本地化用户也有很大的影响，在本地使用需要使用Azure Stack HCI。HCI的账单会从Azure走，进行合并。如果用户没有互联网连接，也就无法使用这项功能。</p><p>虽然没有做到完全的不重启打补丁，这是一种有很多前置条件的<code class="language-plaintext highlighter-rouge">不重启</code>，但这确实在某种程度上改变了和推进了云运维的模式。</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/windows/" class="post-tag no-text-decoration" >Windows</a> <a href="/tags/server/" class="post-tag no-text-decoration" >Server</a> <a href="/tags/2022/" class="post-tag no-text-decoration" >2022</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%E9%9A%8F%E4%BE%BF%E8%81%8A%E8%81%8A%3A%E5%A6%82%E4%BD%95%E7%A1%AC%E6%B0%94%E7%9A%84%E6%89%93%E8%A1%A5%E4%B8%81%E4%B8%8D%E9%87%8D%E5%90%AF+-+%E4%B8%8D%E5%A4%AA%E7%9A%AE%E7%9A%84%E4%B9%9D%E5%8F%94&url=https%3A%2F%2Fkukisama.github.io%2FHow_abloud_hotfix_update_windows_server_2022%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%E9%9A%8F%E4%BE%BF%E8%81%8A%E8%81%8A%3A%E5%A6%82%E4%BD%95%E7%A1%AC%E6%B0%94%E7%9A%84%E6%89%93%E8%A1%A5%E4%B8%81%E4%B8%8D%E9%87%8D%E5%90%AF+-+%E4%B8%8D%E5%A4%AA%E7%9A%AE%E7%9A%84%E4%B9%9D%E5%8F%94&u=https%3A%2F%2Fkukisama.github.io%2FHow_abloud_hotfix_update_windows_server_2022%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fkukisama.github.io%2FHow_abloud_hotfix_update_windows_server_2022%2F&text=%E9%9A%8F%E4%BE%BF%E8%81%8A%E8%81%8A%3A%E5%A6%82%E4%BD%95%E7%A1%AC%E6%B0%94%E7%9A%84%E6%89%93%E8%A1%A5%E4%B8%81%E4%B8%8D%E9%87%8D%E5%90%AF+-+%E4%B8%8D%E5%A4%AA%E7%9A%AE%E7%9A%84%E4%B9%9D%E5%8F%94" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/Cheapest_HCI/">AzureStack HCI的成本精算</a><li><a href="/JekyllfastStart/">Jekyll模板升级笔记</a><li><a href="/PowerShell_quickly_turns_multiple_lines_of_strings_into_objects/">PowerShell快速将多行字符串转成对象</a><li><a href="/SetDynamicMACScriptForHyper-VVrtualMachine/">为Hyper-V虚拟机设置动态MAC的脚本</a><li><a href="/PowerShell_and_i18n_thinking/">PowerShell与i18n的思考</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/powershell%E8%BF%9B%E9%98%B6%E5%AD%A6%E4%B9%A0/">PowerShell进阶学习</a> <a class="post-tag" href="/tags/powershell%E4%BC%98%E5%8C%96/">PowerShell优化</a> <a class="post-tag" href="/tags/powershell%E5%88%9D%E9%98%B6%E5%AD%A6%E4%B9%A0/">PowerShell初阶学习</a> <a class="post-tag" href="/tags/2022/">2022</a> <a class="post-tag" href="/tags/active/">Active</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/directory%E5%9F%9F%E8%BF%9B%E9%98%B6%E5%AD%A6%E4%B9%A0/">Directory域进阶学习</a> <a class="post-tag" href="/tags/hci/">HCI</a> <a class="post-tag" href="/tags/jekyll/">Jekyll</a> <a class="post-tag" href="/tags/sdn/">SDN</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/Cheapest_HCI/"><div class="card-body"> <em class="small" data-ts="1661270400" data-df="YYYY-MM-DD" > 2022-08-24 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AzureStack HCI的成本精算</h3><div class="text-muted small"><p> 不是一个人，而是很多朋友在了解HCI产品后，会觉得AzureStack HCI的价格很高，难落地。 有时候感觉是不太准的，所以我们来详细818 Azure Stack HCI的计费方式，以及这个东西的影响。为了详细的分析，这个事情要分两个方面讨论 跟谁比 怎么用 通过计算，我也希望找到触碰到Azure Statck HCI 底线的配置。底线顾名思义，就是到头了，不能再省钱了...</p></div></div></a></div><div class="card"> <a href="/JekyllfastStart/"><div class="card-body"> <em class="small" data-ts="1660838400" data-df="YYYY-MM-DD" > 2022-08-19 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Jekyll模板升级笔记</h3><div class="text-muted small"><p> Jekyll 是什么 我的博客是托管在Github Pages上的，使用了一种叫做Jekyll的技术构建。最近由于系统邮件一直告诉我有安全漏洞，需要升级，所以我到处找合适的升级模板。 个人理解，Jekyll 基于Ruby开发的，一种和Github Pages 组合使用的代码生成器。能够将markdown格式的文档，生成为html的静态网页。它的特性或者说是适用场景是明确的： ...</p></div></div></a></div><div class="card"> <a href="/WireSharkFastStart/"><div class="card-body"> <em class="small" data-ts="1660665600" data-df="YYYY-MM-DD" > 2022-08-17 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WireShark快速多端点数据捕获</h3><div class="text-muted small"><p> 需求 一般来说，用命令行抓包是因为有以下需求 有很多机器需要同一个时间点抓包 频繁登录到不同主机去启动WireShark比较麻烦 将抓好的数据包拷贝到公共路径还需要花时间，还比如打包之类，这种操作很繁琐。 所以如果只有1、2台机器需要抓包，简单的图形化工具也可以完成。也就没必要了解命令行下的操作。 当然还有另外一个场景： 张三告诉李四，需要李四去抓包 李四...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/VSCode_backup_and_move_process/" class="btn btn-outline-primary" prompt="上一篇"><p>VSCode备份和搬家流程</p></a> <a href="/WhatISMSMVP/" class="btn btn-outline-primary" prompt="下一篇"><p>【谈资】微软MVP，凭什么？</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/jiuzige">不太皮的九叔</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/powershell%E8%BF%9B%E9%98%B6%E5%AD%A6%E4%B9%A0/">PowerShell进阶学习</a> <a class="post-tag" href="/tags/powershell%E4%BC%98%E5%8C%96/">PowerShell优化</a> <a class="post-tag" href="/tags/powershell%E5%88%9D%E9%98%B6%E5%AD%A6%E4%B9%A0/">PowerShell初阶学习</a> <a class="post-tag" href="/tags/2022/">2022</a> <a class="post-tag" href="/tags/active/">Active</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/directory%E5%9F%9F%E8%BF%9B%E9%98%B6%E5%AD%A6%E4%B9%A0/">Directory域进阶学习</a> <a class="post-tag" href="/tags/hci/">HCI</a> <a class="post-tag" href="/tags/jekyll/">Jekyll</a> <a class="post-tag" href="/tags/sdn/">SDN</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">发现新版本的内容。</p><button type="button" class="btn btn-primary" aria-label="Update"> 更新 </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
